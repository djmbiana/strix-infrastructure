#+title: Strix Infrastructure

* Strix in its final form:
GitHub webhook
    ↓
API Gateway (public endpoint)
    ↓
Lambda (private subnet - scanning engine)
    ↓
S3 (scan results)
DynamoDB (scan history)
SNS (alerts)

+ Completely serverless architecture
+ Why no EC2? Strix isn't a long-running process, an always-on service, or custom software. It scans github webhooks and requests.

* Day 01: Building the VPC
** Goals:
*** BUILDING VPC
+ 1 VPC (10.0.0.0/16) = DONE
+ 1 Public subnet = DONE
+ 1 Private subnet = DONE
+ Internet Gateway = DONE
+ NAT Gateway = DONE
+ Route tables configured = DONE

*** PUBLIC INSTANCE
+ CAN SSH IN FROM PC = DONE
+ CAN PING GOOGLE.COM = DONE

*** PRIVATE INSTANCE
+ CANNOT SSH IN FROM PC = DONE
+ CAN SSH FROM PUBLIC INSTANCE = DONE
+ CAN PING AND UPDATE VIA NAT = DONE

** STEP 1: Creating the VPC
+ AWS CONSOLE -> VPC -> CREATE VPC
+ Availability Region: 1 for now, (cost cutting and to build the infrastructure first, can be scaled up later on.)
+ Number of public & private subnets = 2 (one each)
+ NAT Gateway:
  + ZONAL VS REGIONAL
    + Zonal -> Deploy NAT gateway in one availability zone (AZ) and route all private subnets (even from other AZs) to it
      + How it works:
        + NAT gateway lives in AZ-A
        + Private subnets in AZ-A and AZ-B route to that NAT
        + Traffic from AZ-B crosses AZ boundary
      + Pros:
        + Cheaper
        + Simpler setup
        + Alright for dev/low traffic
      + Cons:
        + Single point of failure
        + If AZ-A fails -> internet access will be gone
        + Cross-AZ data charges
        + Slighlty higher latency

    + Regional -> Deploy one NAT gateway per availability zone and route each private subnet to the NAT in the same AZ
      + How it works:
        + NAT-A in AZ-A
        + NAT-B in AZ-B
        + Each private subnet uses its local NAT
        + No cross-AZ routing
      + Pros
        + Highly available
        + No cross-AZ data fees
        + Lower latency
        + Production grade-architechture
        + More expensive (1 NAT per configuration)
+ So what do we use for now? I'd go with Zonal as it is cheaper to manage infrastructure and for our single private & public subnet set up, It would be overkill to have multiple regions for our NAT Gateway

*** STRIX VPC SUMMARY:
+ Nametag -> strix
+ IPv4 CIDR BLOCK -> 10.0.0.0/16
+ IPv6 CIDR BLOCK -> None
+ Tenacy -> Default
+ AZs -> 1 (ap-southeast-1a)
  + Public subnet cidr block -> 10.0.0.0/20
  + Private subnet cidr block -> 10.0.128.0/20
+ NAT Gateway -> Zonal
** STEP 2: Creating instances to connect to the new VPC
*** strix-watchtower
+ This instance will be the machine that uses the public subnet
+ t3.micro (running ubuntu server)
+ Networ k settings:
  + VPC -> Strix VPC
  + Subnet -> strix-subnet-publice (10.0.0.0/20)
  + Auto assign ip address -> Enabled
  + Firewall -> Create security group
    + ssh -> only allow from my ip
**** inside the system
#+begin_src bash
$ ~ ip addr
# output: 10.0.11.177/20

$ ~ ping www.google.com
# output: it pings successfully
#+end_src

*** stix-vault
+ This instance will be the macine that uses the private subnet
+ t3.micro (running ubuntu server)
+ Network settings:
  + VPC -> Strix VPC
  + Subnet -> strix-subnet-private1 (10.0.1.128.0/20)
+ Auto assign ip address -> Enabled
+ Firewall -> New security group
  + ssh -> only allow from public subnet (10.0.0.0/20)
**** inside the system
#+begin_src bash
ip addr
# output:  10.0.133.90/20

# ssh from seneca host
# output: doesn't work = GOOD

# ssh from watchtower
# output: works = GOOD

curl ifconfig.me
# output: 54.169.238.49 (it can connect to the internet via NAT)

ping google.com
# output: it pings successfully

sudo apt update && upgrade
# output: works via NAT, system is now upgraded
#+end_src

* Day 02: Setting up Lambda within VPC
** Why lambda in private subnet for Strix?
Secirty principle: Code that processes untrusted input should be isolated.
From that principle, Strix uses lambda to accomplish that in the following manner:
+ Processes code from GitHub repos (untrusted!)
+ Could contain malicious payloads
+ MUST be isolated from direct internet access
+ Private subnet + NAT = secure architecture

** Goals:
+ Deplay lambda in private subnet
  + Function executes successfully
  + Logs appear in cloud watch
  + Can reach internet via NAT Gateway
+ Understand Lambda + VPC integration
  + Lambda gets IAM permissions
  + Lambda connects to VPC
  + Lambda uses NAT internet access
  + Private subnet isolation protects the function
+ Test the architecture
  + Lambda can process events
  + Lambda can make outbound requests via NAT
  + Lambda is isolated from direct internet access
  + Logs prove everything works

** 1. Create IAM Role for Lambda
+ IAM -> Roles -> Create Role
  + AWS service use case -> Lambda
  + What lambda needs access to:
    + CloudWatch Logs (To write logs)
      + Why?
        + Lambda prints logs
        + Logs need to go somewhere
        + CloudWatch Logs = where these logs go
      + Policy needed: *AWSLambdaBasicExecutionRole*
    + VPC Networking (To run within private subnet)
      + Why?
        + Lambda needs to create network interfaces (ENIs)
        + Lambda needs to attach to your private subnet
        + This how lambda is able to enter the VPC
      + Policy needed: *AWSLambdaVPCAccessExecutionRole*
  + Trusted entities is left on default
    + Trusted entity = who can ASSUME (use this role)
    + For lambda role -> Trusted entity: lambda.amazonaws.com
      + this means that only lambda can use this role

** 2. Create lambda function
+ Lambda -> Create a Function
+ Runtime: Node.Js
  + Node.js is lightweight and has fast cold starts (~100ms vs Python ~200ms). Since Strix processes webhooks sporadically, minimizing cold start time improves response latency.
+ Private subnet -> the scanning engine should operate isolated from the rest of the machine. By nature, the private VPC offers more isolation from the rest of the system and from the greater internet.
+ Security group -> lambda-security-sg (allows lambda to communicate with other services within the vpc. it allows allows lambda to access the internet via NAT)
+ Just using default Lambda code for now to understand how it works

** 3. Test the Function
+ Created a test event and invoked lambda's basic hello function
+ Test event registered in Cloudwatch, So lambda can access cloudwatch.
+ Can lambda reach via nat?
#+begin_src javascript
export const handler = async (event) => {
  console.log('Strix Lambda starting...');

  // Test internet access via NAT
  try {
    const response = await fetch('https://httpbin.org/ip');
    const data = await response.json();

    console.log('Internet access works!');
    console.log('My public IP (via NAT):', data.origin);

    return {
      statusCode: 200,
      body: JSON.stringify({
        message: 'Lambda can reach internet via NAT',
        publicIP: data.origin
      })
    };
  } catch (error) {
    console.log('Internet access failed:', error.message);
    return {
      statusCode: 500,
      body: JSON.stringify({
        message: 'Failed to reach internet',
        error: error.message
      })
    };
  }
};
#+end_src
+ Output: Success! Lambda can access the internet via NAT
